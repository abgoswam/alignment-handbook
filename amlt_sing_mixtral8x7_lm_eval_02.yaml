description: mixtral8x7_lm_eval_trials

target:  
  service: sing  
  name: aims-sing-east-us2 #GenAI-Shared-CanadaCtr #aims-sing-east-us2  
  workspace_name: aims-sing-res-eu-WS

environment:
  # image: nvidia24.01-ds0.13.1-fa2.5.3-te1.4.0.beta-mb0.5.1:20240210
  #image: nvidia24.01-ds0.13.3-fa2.5.3-te1.4.0.beta-mb0.5.1-gg:20240222
  image: customized_nvcr:nvidia24.03-ds0.14.1.b-fa2.5.6-te1.6.0.beta2-mb0.5.1.b2-gg.b-20240331
  # image: h100-nvidia23.10-pytorch2.1.1-cuda12.2.2-deepspeed0.12.3-flashattn2.5.2:v0.1
  username: structureddl
  registry: structureddl.azurecr.io
  setup:
    - set -e -o xtrace
    - echo "export PATH=$$PATH:$$HOME/.local/bin" >> ~/.bashrc && source ~/.bashrc 
    - echo $$HOME
    - echo "------------"
    - echo $$PATH
    - echo "============"
    - mkdir -p ~/.cache/huggingface && echo -n "[hf-token]" > ~/.cache/huggingface/token
    - pip list
    - echo 'Above is packages before launch cmd'
    - pip install lm_eval[vllm]==0.4.1
    - pip list 
    - nvcc --version
 
code:
  local_dir: $CONFIG_DIR/

jobs:
- name: issue_1079_mixtral8x7_lm_eval
  sla_tier: premium  # Default: premium
  execution_mode: basic  # Default: basic
  sku: G8
  priority: high
  process_count_per_node: 1
  command:
    - export PATH=$$HOME/.local/bin/:$$PATH
    - echo "check filesystem space"
    - df -h
    - echo "check pwd"
    - pwd
    - ls -lh
    - bash run_lm_eval.sh

  submit_args:
    max_run_duration_seconds: 1209600   # 14 days
    env:
      {
        "SINGULARITY_MPI_ENV": "-mca pml ucx -mca coll ^hcoll --bind-to numa -x RX_QUEUE_LEN=8192 -x IB_RX_QUEUE_LEN=8192 -x UCX_TLS=tcp -x HCOLL_ENABLE_MCAST_ALL=0 -x coll_hcoll_enable=0 -x UCX_NET_DEVICES=eth0 -x NCCL_IB_TIMEOUT=16 -x NCCL_IB_SL=0 -x NCCL_IB_TC=41 -x NCCL_IB_GID_INDEX=3 -x NCCL_IB_QPS_PER_CONNECTION=4 -x NCCL_IB_HCA=mlx5_1,mlx5_2,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_7,mlx5_8,mlx5_9,mlx5_10,mlx5_11,mlx5_12,mlx5_14,mlx5_15,mlx5_16,mlx5_17 -x NCCL_SOCKET_IFNAME=eth0 -x NCCL_DEBUG=INFO"
      }